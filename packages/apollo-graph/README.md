# @talon/apollo-graph

# Why?

Let's say we want this query to work:

```graphql
type Query {
  account(id: ID): Account
}
```

Apollo Server has four options `{typeDefs, context, dataSources, resolvers}`

A `resolver` is a connection (edge) from a GraphQL query that abstracts _how data is retrieved_

```js
{
  Query: {
    account: (parent, params, context) => Promise.resolve({id: 1})
  }
}
```
> They look kinda like GraphQL cause they kinda are like that but in JS and actually connected to the data.

Since the resolver technically only handles mapping queries to Promises, Apollo Server also introduces the concept of a [data source](https://www.npmjs.com/package/apollo-datasource). Which handles a few things, but for now let's look at how our implementation plays out if we simply use [apollo-datasource-rest](https://www.npmjs.com/package/apollo-datasource-rest) to get an account from Mastodon.

```js
class Mastodon extends RESTDataSource {
  get baseUrl() {
    return "mastodon.technology"
  }

  accounts(params) {
    this.get(`/api/v1/${params.id}`)
  }
}

const server = new ApolloServer({
  dataSources: {
    mastodon: new Mastodon()
  }
})
```

So we extended the `RESTDataSource`, wrote a method for retrieving an `account` and instantiated it as `dataSources.mastodon` in Apollo Server. This will create `context.dataSources.mastodon.account` which can be consumed by the resolver like so:

```js
const server = new ApolloServer({
  dataSources: {
    mastodon: new Mastodon()
  },
  resolvers: {
    Query: {
      account: ({parent, params, context}) => 
        context.dataSources.mastodon.account(params)
    }
  }
})
```

With this final stroke we've completed the implementation of our `account` query. But perhaps we can do better! ðŸ”¬

## Occam's Razor

That's all kinda messy and we only did one thing: _map the `account` query to the `/api/v1/:id/accounts` REST endpoint_. It's not that messy to _describe_, in fact it's pretty simple. That's our razor.

 ```js
 {
   get: {
     account: "/api/v1/:id"
   }
 }
 ```
> _map the `account` query to the `/api/v1/:id/accounts` REST endpoint_

We can use this config to _derive the data source methods_ and distinguish between a Query (GET) and Mutation (POST, PUT, PATCH, DELETE) so we can also _derive the resolvers from the data source_.

We'll also want to depend on things in `context`. We'll declare those like this

```js
{
  data: async () => ""
}
```

It inverts the way context normally works but allows implementations to also know what keys are being depended on in the `context`.

Let's call our new type `Node`, it usurps `DataSource` and there will be an implementation of such per data source implementation.
Currently only REST is supported.

```js
Node.REST("mastodon", {
  baseUrl: async () => "mastodon.technology",
}, {
  get: {
    account: "/api/v1/accounts/:id"
  }
})
```

One or more nodes can be composed with `Graph.fromNodes` and served by Apollo Server.

Node implementations handle the dirty work of applying the razor, consumers enjoy the benefits.

# API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

- [fromNodes](#fromnodes)
  - [Parameters](#parameters)
- [RESTEdge](#restedge)
  - [Parameters](#parameters-1)
  - [Examples](#examples)

## fromNodes

- **See: RESTEdge**

build a Graph.fromNodes

nodes are objects of the shape
{ typeDefs, context, dataSources }

where `dataSources` is an array of `Edges`

### Parameters

- `nodes` **[array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)**

Returns **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**

## RESTEdge

**Extends RESTDataSource**

Declaritively map GraphQL queries to REST endpoints

### Parameters

- `$0` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**
  - `$0.resource`
  - `$0.name`
  - `$0.instance`
  - `$0.authorization`
- `bind` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** map GraphQL queries to REST routes
- `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**

### Examples

```javascript
new RESTEdge(
  {
    name: "mastodon.accounts",
    resource: "/api/v1/accounts",
    instance: "mastodon.instance",
    authorization: "mastodon.authorization"
  },
  {
    get: {
      account: "/:id",
      followers: "/:id/followers",
      following: "/:id/followers",
      relationships: "/:id/relationships",
      search: "/:id/search",
      statuses: "/:id/statuses",
      verify_credentials: "/:id/verify_credentials"
    },
    post: {
      accounts: "/:id/",
      follow: "/:id/follow",
      unfollow: "/:id/unfollow"
    },
    patch: {
      update_credentials: "update_credentials"
    }
  }
);
```
